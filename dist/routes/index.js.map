{"version":3,"file":"index.js","names":["router","require","Router","get","req","res","testWaCallbackUrl","error","console","sendStatus","post","log","data","Whatsapp","parseMessage","body","isMessage","incomingMessage","message","recipientPhone","from","phone","recipientName","name","typeOfMsg","type","message_id","textMessage","text","includes","trim","toLowerCase","connection","query","err","fields","sendSimpleButtons","listOfButtons","title","id","markMessageAsRead","computeGetRate","titleCase","str","splitStr","split","i","length","charAt","toUpperCase","substring","join","module","exports"],"sources":["../../src/routes/index.js"],"sourcesContent":["'use strict';\n\nimport Whatsapp from '../config/whatsapp';\nimport connection from '../config/db';\nimport testWaCallbackUrl from '../helpers/testWaCallbackUrl';\nimport computeGetRate from '../functions/getRate/computeGetRate';\n\nconst router = require('express').Router();\n\nrouter.get('/meta_wa_callbackurl', (req, res) => {\n    try {\n        testWaCallbackUrl(req, res);\n    } catch (error) {\n        console.error({ error });\n        return res.sendStatus(500);\n    }\n});\n\nrouter.post('/meta_wa_callbackurl', async (req, res) => {\n    console.log('POST: Someone is pinging me!');\n\n    try {\n        let data = Whatsapp.parseMessage(req.body);\n\n        console.log('dataxx', data);\n        // console.log('req.body', req.body.entry[0].changes)\n        // data.notificationMessage && console.log(\"CONVERSATIONXX\", data.notificationMessage.conversation.origin )\n\n        if (data?.isMessage) {\n            let incomingMessage = data.message;\n            let recipientPhone = incomingMessage.from.phone; // extract the phone number of sender\n            let recipientName = incomingMessage.from.name;\n            let typeOfMsg = incomingMessage.type; // extract the type of message (some are text, others are images, others are responses to buttons etc...)\n            let message_id = incomingMessage.message_id; // extract the message id\n            let textMessage = incomingMessage.text?.body; // extract text message body\n\n            // if msg === \"hi\" ///////////////////////////////////////////////////////////////\n            if (\n                textMessage &&\n                ['hi', 'hello'].includes(textMessage.trim().toLowerCase())\n            ) {\n                connection.query(\n                    `INSERT INTO whatsapp_cloud (phone_no, username) VALUES ('${recipientPhone}', '${recipientName}');`,\n                    (err, res, fields) => {\n                        if (err) {\n                            connection.query(\n                                `UPDATE whatsapp_cloud SET latest_question = 'new' WHERE phone_no = '${recipientPhone}';`,\n                                (err, res, fields) => {\n                                    if (err) throw err;\n                                }\n                            );\n                        }\n                    }\n                );\n\n                await Whatsapp.sendSimpleButtons({\n                    message: `Welcome to CAS BROKER, ${recipientName}.\\nWhat do you want to do?`,\n                    recipientPhone: recipientPhone,\n                    listOfButtons: [\n                        {\n                            title: 'Get rate',\n                            id: 'get_rate',\n                        },\n                        {\n                            title: 'Find load',\n                            id: 'find_load',\n                        },\n                        {\n                            title: 'Post load',\n                            id: 'post_load',\n                        },\n                        // {\n                        //   title: \"Speak to a human\",\n                        //   id: \"speak_to_human\",\n                        // },\n                    ],\n                });\n                await Whatsapp.markMessageAsRead({\n                    message_id,\n                });\n                return res.sendStatus(200); // break\n            }\n            // End if msg === \"hi\" ////////////////////////////////////////////////////////////////////////\n\n            //////////////////////  button_reply == \"get_rate\"  //////////////////////////////////////////////\n            await computeGetRate(\n                typeOfMsg,\n                incomingMessage,\n                recipientPhone,\n                message_id,\n                res,\n                textMessage\n            );\n            /////////////////////////////////////////////////////////////////////////////////////////\n        }\n        return res.sendStatus(200);\n    } catch (error) {\n        console.error({ error });\n        return res.sendStatus(500);\n    }\n\n    //   connection.end()\n});\n\nexport function titleCase(str) {\n    var splitStr = str.toLowerCase().split(' ');\n    for (var i = 0; i < splitStr.length; i++) {\n        // You do not need to check if i is larger than splitStr length, as your for does that for you\n        // Assign it back to the array\n        splitStr[i] =\n            splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1);\n    }\n    // Directly return the joined string\n    return splitStr.join(' ');\n}\n\nmodule.exports = router;\n"],"mappings":"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"}