{"version":3,"file":"selectDestination.js","names":["selectDestination","recipientPhone","textMessage","res","message_id","connection","query","err","rows","fields","latest_question","sdrAction","message","destination_region","JSON","parse","stringify","i","length","concat","titleCase","name","toLowerCase","console","log","Whatsapp","sendText","markMessageAsRead","sendStatus","flag","Boolean"],"sources":["../../../src/functions/getRate/selectDestination.js"],"sourcesContent":["'use strict';\nimport Whatsapp from '../../config/whatsapp';\nimport connection from '../../config/db';\nimport { titleCase } from '../../routes';\n\nexport default async function selectDestination(recipientPhone, textMessage, res, message_id) {\n  connection.query(\n    `SELECT latest_question FROM whatsapp_cloud WHERE phone_no = '${recipientPhone}'`,\n    async (err, rows, fields) => {\n      if (err)\n        throw err;\n      const latest_question = rows[0].latest_question;\n\n      if (latest_question === 'select destination region') {\n        sdrAction(textMessage, recipientPhone);\n        // send \"select pickup destination\" + pickup destinations (list)\n        let message = '';\n\n        connection.query(\n          `SELECT destination_region FROM whatsapp_cloud WHERE phone_no = '${recipientPhone}'`,\n          async (err, rows, fields) => {\n            if (err)\n              throw err;\n\n            connection.query(\n              `SELECT name FROM destinationrates WHERE region_id = '${rows[0].destination_region}'`,\n              async (err, rows, fields) => {\n                if (err)\n                  throw err;\n                rows = JSON.parse(JSON.stringify(rows));\n                for (let i = 0; i < rows.length; i++) {\n                  message = message.concat(\n                    `${i + 1}. ${titleCase(\n                      rows[i].name.toLowerCase()\n                    )}\\n`\n                  );\n                }\n                console.log(res);\n                await Whatsapp.sendText({\n                  recipientPhone: recipientPhone,\n                  message: 'Select pickup destination\\n\\n' +\n                    message,\n                });\n              }\n            );\n          }\n        );\n        await Whatsapp.markMessageAsRead({\n          message_id,\n        });\n        return res.sendStatus(200);\n      }\n    }\n  );\n}\n\nfunction sdrAction(message, recipientPhone) {\n  let flag = 0;\n  connection.query(\n      `UPDATE whatsapp_cloud SET destination_region = '${message}' WHERE phone_no = '${recipientPhone}';`,\n      (err, res, fields) => {\n          if (err) flag = 1;\n      }\n  );\n\n  connection.query(\n      `UPDATE whatsapp_cloud SET latest_question = 'select pickup destination' WHERE phone_no = '${recipientPhone}';`,\n      (err, res, fields) => {\n          if (err) flag = 1;\n      }\n  );\n  return !Boolean(flag);\n}"],"mappings":"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"}